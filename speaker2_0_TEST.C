//speaker TEST code
//playing mario
//Author: Yash Jivrajani

//header files
 
#define F_CPU 14745600
#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>

//tone description

int a[] = {0x4D,0x00,0x4D,0x00,0x00,0x00,0x4D,0x00,0x00,0x00,0x2D,0x08,0x4D,0x00,0x00,0x00,0x40,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x2D,0x08,0x00,0x00,0x00,0x00,0x20,0x06,0x00,0x00,0x00,0x00,0x27,0x05,0x00,0x00,0x00,0x00,0xE0,0x06,0x00,0x00,0xB8,0x07,0x00,0x00,0x49,0x07,0xE0,0x06,0x00,0x00,0x20,0x06,0x4D,0x0A,0x40,0x0C,0xC0,0x0D,0x00,0x00,0xEA,0x0A,0x40,0x0C,0x00,0x00,0x4D,0x0A,0x00,0x00,0x2D,0x08,0x2D,0x09,0xB8,0x07,0x00,0x00,0x00,0x00,0x2D,0x08,0x00,0x00,0x00,0x00,0x20,0x06,0x00,0x00,0x00,0x00,0x27,0x05,0x00,0x00,0x00,0x00,0xE0,0x06,0x00,0x00,0xB8,0x07,0x00,0x00,0x49,0x07,0xE0,0x06,0x00,0x00,0x20,0x06,0x4D,0x0A,0x40,0x0C,0xC0,0x0D,0xC0,0x0D,0x00,0x00,0xEA,0x0A,0x40,0x0C,0x00,0x00,0x4D,0x0A,0x00,0x00,0x2D,0x08,0x2D,0x09,0xB8,0x07,0x00,0x00}

int b[] ={12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,9,9,9,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,9,9,9,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,9,9,9,12,12,12,12,12,12,12,12,12,12,12,12}


//Function to configure ports to enable robot's motion
void speaker_pin_config (void) 
{
 DDRH = DDRH | 0x20;   //Setting PL3 and PL4 pins as output for PWM generation
 PORTL = PORTL | 0x20; //PL3 and PL4 pins are for velocity control using PWM.
}

//Function to initialize ports
void init_ports()
{
 speaker_pin_config();
}

// Timer 4 initialized in PWM mode for velocity control
// Prescale:1024
// PWM 10-bit fast, TOP=0x03FF
// Timer Frequency:14400.00 Hz

void timer4_init()
{
	TCCR4B = 0x00;	//Stop
	TCNT4H = 0x00;	//Counter higher 8-bit value to which OCR4xH value is compared with
	TCNT4L = 0x00;	//Counter lower 8-bit value to which OCR5xH value is compared with
	OCR4AH = 0x00;	//Output compare register high value for speaker
	OCR4AL = 0x00;	//Output compare register low value for speaker
	TCCR4A = 0xFF;	//{COM4A1=1, COM4A0=1; COM4B1=1, COM4B0=1; COM1C1=1 COM1C0=0}
 					//For Overriding normal port functionality to OCRnA outputs.
				  	//{WGM41=1, WGM40=1} Along With WGM52 in TCCR5B for Selecting FAST PWM 10-bit Mode*/
	
	TCCR4B = 0x1D;	//WGM42=1,CS12=1, CS11=0, CS10=1 (Prescaler=14400)
}

void init_devices (void) //use this function to initialize all devices
{
 cli(); //disable all interrupts
 init_ports();
 timer4_init();
 sei(); //re-enable interrupts
}

int main()
{
	init_devices();
	while(1)
	{
		int i = 0;
		for(i = 0; i <= 156; i++)
		{
			OCR4AH = a[i]
			OCR4AL = a[i+1];
			_delay_ms(1000/b[i])
			i++
		}
	}
	return 0;
}

